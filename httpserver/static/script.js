var keyboardMap = [
    "", // [0]
    "", // [1]
    "", // [2]
    "CANCEL", // [3]
    "", // [4]
    "", // [5]
    "HELP", // [6]
    "", // [7]
    "BACKSPACE", // [8]
    "TAB", // [9]
    "", // [10]
    "", // [11]
    "CLEAR", // [12]
    "ENTER", // [13]
    "ENTER SPECIAL", // [14]
    "", // [15]
    "SHIFT", // [16]
    "CONTROL", // [17]
    "ALT", // [18]
    "PAUSE", // [19]
    "CAPSLOCK", // [20]
    "KANA", // [21]
    "EISU", // [22]
    "JUNJA", // [23]
    "FINAL", // [24]
    "HANJA", // [25]
    "", // [26]
    "ESCAPE", // [27]
    "CONVERT", // [28]
    "NONCONVERT", // [29]
    "ACCEPT", // [30]
    "MODECHANGE", // [31]
    "SPACE", // [32]
    "PAGE_UP", // [33]
    "PAGE_DOWN", // [34]
    "END", // [35]
    "HOME", // [36]
    "LEFT", // [37]
    "UP", // [38]
    "RIGHT", // [39]
    "DOWN", // [40]
    "SELECT", // [41]
    "PRINT", // [42]
    "EXECUTE", // [43]
    "PRINTSCREEN", // [44]
    "INSERT", // [45]
    "DELETE", // [46]
    "", // [47]
    "0", // [48]
    "1", // [49]
    "2", // [50]
    "3", // [51]
    "4", // [52]
    "5", // [53]
    "6", // [54]
    "7", // [55]
    "8", // [56]
    "9", // [57]
    "COLON", // [58]
    "SEMICOLON", // [59]
    "<", // [60]
    "=", // [61]
    ">", // [62]
    "?", // [63]
    "AT", // [64]
    "A", // [65]
    "B", // [66]
    "C", // [67]
    "D", // [68]
    "E", // [69]
    "F", // [70]
    "G", // [71]
    "H", // [72]
    "I", // [73]
    "J", // [74]
    "K", // [75]
    "L", // [76]
    "M", // [77]
    "N", // [78]
    "O", // [79]
    "P", // [80]
    "Q", // [81]
    "R", // [82]
    "S", // [83]
    "T", // [84]
    "U", // [85]
    "V", // [86]
    "W", // [87]
    "X", // [88]
    "Y", // [89]
    "Z", // [90]
    "OS_KEY", // [91] Windows Key (Windows) or Command Key (Mac)
    "", // [92]
    "CONTEXT_MENU", // [93]
    "", // [94]
    "SLEEP", // [95]
    "NUMPAD_0", // [96]
    "NUMPAD_1", // [97]
    "NUMPAD_2", // [98]
    "NUMPAD_3", // [99]
    "NUMPAD_4", // [100]
    "NUMPAD_5", // [101]
    "NUMPAD_6", // [102]
    "NUMPAD_7", // [103]
    "NUMPAD_8", // [104]
    "NUMPAD_9", // [105]
    "MULTIPLY", // [106]
    "ADD", // [107]
    "SEPARATOR", // [108]
    "SUBTRACT", // [109]
    "DECIMAL", // [110]
    "DIVIDE", // [111]
    "F1", // [112]
    "F2", // [113]
    "F3", // [114]
    "F4", // [115]
    "F5", // [116]
    "F6", // [117]
    "F7", // [118]
    "F8", // [119]
    "F9", // [120]
    "F10", // [121]
    "F11", // [122]
    "F12", // [123]
    "F13", // [124]
    "F14", // [125]
    "F15", // [126]
    "F16", // [127]
    "F17", // [128]
    "F18", // [129]
    "F19", // [130]
    "F20", // [131]
    "F21", // [132]
    "F22", // [133]
    "F23", // [134]
    "F24", // [135]
    "", // [136]
    "", // [137]
    "", // [138]
    "", // [139]
    "", // [140]
    "", // [141]
    "", // [142]
    "", // [143]
    "NUM_LOCK", // [144]
    "SCROLL_LOCK", // [145]
    "WIN_OEM_FJ_JISHO", // [146]
    "WIN_OEM_FJ_MASSHOU", // [147]
    "WIN_OEM_FJ_TOUROKU", // [148]
    "WIN_OEM_FJ_LOYA", // [149]
    "WIN_OEM_FJ_ROYA", // [150]
    "", // [151]
    "", // [152]
    "", // [153]
    "", // [154]
    "", // [155]
    "", // [156]
    "", // [157]
    "", // [158]
    "", // [159]
    "CIRCUMFLEX", // [160]
    "EXCLAMATION", // [161]
    "DOUBLE_QUOTE", // [162]
    "HASH", // [163]
    "DOLLAR", // [164]
    "PERCENT", // [165]
    "AMPERSAND", // [166]
    "UNDERSCORE", // [167]
    "OPEN_PAREN", // [168]
    "CLOSE_PAREN", // [169]
    "ASTERISK", // [170]
    "PLUS", // [171]
    "PIPE", // [172]
    "HYPHEN_MINUS", // [173]
    "OPEN_CURLY_BRACKET", // [174]
    "CLOSE_CURLY_BRACKET", // [175]
    "TILDE", // [176]
    "", // [177]
    "", // [178]
    "", // [179]
    "", // [180]
    "VOLUME_MUTE", // [181]
    "VOLUME_DOWN", // [182]
    "VOLUME_UP", // [183]
    "", // [184]
    "", // [185]
    "SEMICOLON", // [186]
    "EQUALS", // [187]
    "COMMA", // [188]
    "MINUS", // [189]
    "PERIOD", // [190]
    "SLASH", // [191]
    "BACK_QUOTE", // [192]
    "", // [193]
    "", // [194]
    "", // [195]
    "", // [196]
    "", // [197]
    "", // [198]
    "", // [199]
    "", // [200]
    "", // [201]
    "", // [202]
    "", // [203]
    "", // [204]
    "", // [205]
    "", // [206]
    "", // [207]
    "", // [208]
    "", // [209]
    "", // [210]
    "", // [211]
    "", // [212]
    "", // [213]
    "", // [214]
    "", // [215]
    "", // [216]
    "", // [217]
    "", // [218]
    "OPEN_BRACKET", // [219]
    "BACK_SLASH", // [220]
    "CLOSE_BRACKET", // [221]
    "QUOTE", // [222]
    "", // [223]
    "META", // [224]
    "ALTGR", // [225]
    "", // [226]
    "WIN_ICO_HELP", // [227]
    "WIN_ICO_00", // [228]
    "", // [229]
    "WIN_ICO_CLEAR", // [230]
    "", // [231]
    "", // [232]
    "WIN_OEM_RESET", // [233]
    "WIN_OEM_JUMP", // [234]
    "WIN_OEM_PA1", // [235]
    "WIN_OEM_PA2", // [236]
    "WIN_OEM_PA3", // [237]
    "WIN_OEM_WSCTRL", // [238]
    "WIN_OEM_CUSEL", // [239]
    "WIN_OEM_ATTN", // [240]
    "WIN_OEM_FINISH", // [241]
    "WIN_OEM_COPY", // [242]
    "WIN_OEM_AUTO", // [243]
    "WIN_OEM_ENLW", // [244]
    "WIN_OEM_BACKTAB", // [245]
    "ATTN", // [246]
    "CRSEL", // [247]
    "EXSEL", // [248]
    "EREOF", // [249]
    "PLAY", // [250]
    "ZOOM", // [251]
    "", // [252]
    "PA1", // [253]
    "WIN_OEM_CLEAR", // [254]
    "" // [255]
  ];

PIXI.sound.add("MainMenuMusic",{
    url: "static\\mainMenuMusic.mp3",
    autoPlay:true
   })

function hexToRgb(hex) {
  var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? [
     parseInt(result[1], 16),
     parseInt(result[2], 16),
     parseInt(result[3], 16)
   ]: null;
}

function rgbToHex(r, g, b) {
  return "#" + (1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1);
}

let tree_size = new Map()
tree_size.set(0,0.1)
tree_size.set(1,0.15)
tree_size.set(2,0.2)
tree_size.set(3,0.25)

document.onkeydown=function(event) {
    if (event.keyCode == 9 || event.keyCode == 112 || event.keyCode == 114 ) {  //tab pressed
        event.preventDefault(); // stops its action
    }
}

document.getElementById("ServerAddress").value =document.getElementById("ServerSelect").value
function ZoomCorrection(){
    if (VIEW_X > 0 && VIEW_Y > 0){
    if (VIEW_X/VIEW_Y > GameW/GameH){
        if (Zoom < GameH/VIEW_Y/2){
            Zoom = GameH/VIEW_Y/2
        }
    }else{
        if (Zoom < GameW/VIEW_X/2){
            Zoom = GameW/VIEW_X/2
        }
    }}
}
let GameStatus = "MainMenu"

let BGLayers = [[0,"../static/BG1/BG.svg"],[0.0625,"../static/BG1/BG0.svg"],[ 0.03125,"../static/BG1/BG1.svg"],[0.015625,"../static/BG1/BG2.svg"],[ 0.0078125,"../static/BG1/BG3.svg"],[-0.00390625,"../static/BG1/BG4.svg"]]
function UpdateBG(e){
    MainScreen.innerHTML = ""
    for (let i = 0; i < BGLayers.length; i++) {
        MainScreen.innerHTML += '<div class="BGSVGLayer" id="SvgLayer'+i+'" style="background-image: url('+BGLayers[i][1]+');"></div>'
    }
}
UpdateBG()
document.addEventListener('mousemove', onMouseUpdate, false);
document.addEventListener('mouseenter', onMouseUpdate, false);
function forgetServer(){
    document.getElementById('online').innerHTML = '?/?'
    document.getElementById('text').innerHTML = 'No information yet'
    document.getElementById('impprev').src = ''
    document.getElementById('spimpprev').src = ''

}
function onMouseUpdate(e) {
  let x = e.pageX;
  for (let i = 0; i < BGLayers.length; i++) {
        document.getElementById("SvgLayer"+i).style.transform= 'translateX('+((x - window.innerWidth / 2) * BGLayers[i][0])*1920/window.innerWidth+'px)'
  }

}
window.onresize = resize
function ExitGame(){
    GameStatus = "MainMenu"
    PlayersData = new Map()
    PIXI.sound.play('MainMenuMusic');
    document.getElementById('chk-game').checked = false
    document.getElementById("chkInterfaceHide").checked = false
    Players = []
    indicators.innerHTML = ""
    TVehicles = new Map()

    socket.close();



}

let ParticlesProcessing = true
if (localStorage.getItem("SettingsParticlesChkVal") != '' && localStorage.getItem("SettingsParticlesChkVal") != null){
ParticlesProcessing = localStorage.getItem("SettingsParticlesChkVal")=='true'

}
document.getElementById('ParticlesChk').checked = ParticlesProcessing
document.getElementById("NameField").value = sessionStorage.getItem('NameFieldVal')
function ChSttSettings(){
    if (document.getElementById("SettingsForm").style.display == "none"){
        document.getElementById("SettingsForm").style.display = "block"
    }else{
        document.getElementById("SettingsForm").style.display = "none"
    }
}

function UpdtParticles(){

    ParticlesProcessing =  document.getElementById('ParticlesChk').checked
    localStorage.setItem("SettingsParticlesChkVal", document.getElementById('ParticlesChk').checked)

}
function UpdtVolumes(){

    let s =  document.getElementById('VolumeRange').value
    let m =  document.getElementById('MusicRange').value
    localStorage.setItem("SettingsVolumeRangeVal", s)
    localStorage.setItem("SettingsMusicRangeVal", m)
    PIXI.sound.volume('MainMenuMusic',m)
    PIXI.sound.volumeAll = s

    //MusicRange
}

function keybindOnKeyDown(event){
    // console.log(event)
    // console.log()
    let id = event.target.id.slice(10)
    let keyCode = event.keyCode

    localStorage.setItem(PACK_ID+"k"+id,keyCode)
    try{
        TVehicles.get(CurVehicleID).input_keys.forEach(ik => {
           ik.update()          
            
        
    });
    }catch{}
    event.target.value = keyboardMap[keyCode]
    event.target.blur()
    play_click_sound()
    // if (localStorage.hasOwnProperty(PACK_ID+"k"+this.id)){
    //     this.cur_char = Number(localStorage.getItem(PACK_ID+"k"+this.id))
    // }


}

function UpdtKeybinds(){
    keybinds_list.innerHTML = ""

    for (const [key, ik] of Object.entries(IK)) {
        ik.update()
        keybinds_list.innerHTML += '<div class=\"keybind\"><span><img src=\"'+ik.icon_link+ '\"><b>'+ik.name+'</b></span><span><input type=\"button\" onclick="play_click_sound()" id="keybindbtn'+ik.id+'" class=\"keyinput\"  value=\"'+keyboardMap[ik.cur_char]+'\"></span></div>'

        console.log(ik.id,ik.name,ik.cur_char,ik.icon_link);
    }
    keybinds_list.innerHTML += "<br><br>"
    BindKeybinds()
}

function BindKeybinds(){

    for (const [key, ik] of Object.entries(IK)) {
        let btn = document.getElementById('keybindbtn'+ik.id)
        // id="keybindbtn'+key+'" 
        console.log(btn)
        btn.onkeydown=keybindOnKeyDown
        console.log(btn.onkeydown)
        btn.addEventListener('keypressed', keybindOnKeyDown, false)

    }
}

var PlayerTags = new Map()
function NoTeamTag(name, updTags=false){
    if (name == undefined){
    return undefined
    }
    if (name.split("]").length > 1){
        if (updTags) PlayerTags.set(name.split("]")[1],name.split("]")[0].slice(1))
        return name.split("]")[1]

    }else{
        if (updTags) PlayerTags.set(name,null)
        return name
    }
}
let GameH = 0
let GameW = 0

PIXI.sound.add("bang","static\\bang.mp3")
PIXI.sound.add("wtrBang","static\\wtrBang.mp3")
PIXI.sound.add("lnchTrpd","static\\TorpedoLaunch.mp3")
PIXI.sound.add("lnchRckt","static\\RocketLaunch.mp3")
PIXI.sound.add("bombFall","static\\bombFall4s.mp3")
PIXI.sound.add("rocketHit","static\\rocketHit.mp3")

PIXI.sound.add("dmg0","static\\dmg\\0.mp3")
PIXI.sound.add("dmg1","static\\dmg\\1.mp3")
PIXI.sound.add("dmg2","static\\dmg\\2.mp3")
PIXI.sound.add("dmg3","static\\dmg\\3.mp3")

PIXI.sound.add("Sdmg0","static\\Sdmg\\0.mp3")
PIXI.sound.add("Sdmg1","static\\Sdmg\\1.mp3")

PIXI.sound.add("mcanon","static\\mcanon.mp3")
PIXI.sound.add("pcanon","static\\pcanon.mp3")
PIXI.sound.add("tcanon","static\\mcanon.mp3")
PIXI.sound.add("hcanon","static\\pcanon.mp3")
PIXI.sound.add("fcanon","static\\pcanon.mp3")

let TVehicles = new Map()
let module_view_mode = false
var cameraMode = false;
var Players=[];
var TorpedosData = new Map();
var AARocketsData = new Map();
var BombsData = new Map();
var BulletsData = new Map();
var SmokesData = new Map();
var ColorPack = 'Summer';
var Vehicles;
var PlayersData = new Map();
var RolesList;
var VIEW_X = 0
var VIEW_Y = 0
var PlayerName;
let PlayerVehicleID = 0
var CurVehicle;
// var Zones = '';
var SelectedVehicleShopId = null
function onWheel(e){
    if (e.deltaY > 0){
        Zoom -= 10
    }else{
        Zoom += 10
    }
    if (Zoom > 640){Zoom = 640}
    ZoomCorrection()
}
// function ShowPrevVeh(){
//     sessionStorage.setItem('VehicleSelectVal',document.getElementById('VehicleSelect').value)
// 	for (let _ of VehList) {
//         if(_[1]==document.getElementById('VehicleSelect').value){
//             document.getElementById('vehprev').src = _[2];
//             SelectedVehicleShopId = _[3]
//             break;
//         }
// 	}
// }

function drawLayer(layer) {
    for (let _ of Entities.keys()) {
        Entities.get(_).draw(layer)

    }
    TVehicles.forEach(vehicle => {
        if (vehicle.id == CurVehicleID){
            vehicle.drawp(layer)
        }else{
            vehicle.drawe(layer)
        }
    })
    if (Particles.has(layer)){
        Particles.get(layer).forEach(particle => {
            particle.draw()
        })
    }
    if (Strucures.get(layer)){
        Strucures.get(layer).forEach(structure => {
            structure.draw()
        })
    }
    try{
        if (LayersFunctions.hasOwnProperty(layer)){
            LayersFunctions[layer]()
    
        }
    }catch{}

}
function onPackageLoaded(){
    UpdtKeybinds()
}
function GetSpawnInfo(){
    try{
        let soc = new WebSocket(document.getElementById('ServerAddress').value);

        soc.addEventListener('open', function (event) {
//                    console.log('!');
            soc.send('resp'+RoleSelect.value);
        });

        function taken(event) {
//                    console.log(event.data)
            console.log(event.data)
            var data = JSON.parse(event.data);
//                    console.log(data)
            console.log(data)
            document.getElementById('spcontainer').innerHTML = ''
            let vehlst = ""
            for (let key in data) {
                document.getElementById('spcontainer').innerHTML += '<label class="spawnpoint" for="sp'+key+'" style="top:calc(100% * '+data[key].pos[1]+' / '+WH+');left:calc(100% * '+data[key].pos[0]+' / '+WH+');"><input type="radio" id="sp'+key+'" checked value="'+key+'" name="SpawnPoints" onclick="play_click_sound();vs'+key+'.checked=true;"><img src="'+data[key].ico+'"></label>'
              vehlst += '<div class="vehlist"><input class="VehiclesList" checked  type="radio" id="vs'+key+'"  value="'+key+'" name="VehicleLists"><div class="scrollbar VehiclesList">'
              for (let k of data[key].vehicles) {
                let amount = "-"
                if (k[3]>=0){
                    amount = k[3]
                }
                let dis = ''
                let chk = ' checked '
                if (amount==0){
                    dis = ' disabled '
                    chk = ''
                }
                vehlst +='<label class="unselectable vehiclecard" onclick="play_click_sound()" '+dis+'><span class="vhcrdamount">'+amount+'</span><input class="unselectable" '+chk+' '+dis+' type="radio" name="veh'+k[1]+'" value="'+k[1]+'"  ><img src="'+k[2]+'" alt="'+k[0]+'" ><span class="vhcrdname">'+k[0]+'</span></label>'
			  }
              vehlst += '</div></div>'
				
            }
            VHcontainer.innerHTML = vehlst

        }

        soc.addEventListener('message', taken);
    }catch{

    }
}
function GetServerInfo(){
            try{
                let soc = new WebSocket(document.getElementById('ServerAddress').value);

                soc.addEventListener('open', function (event) {
//                    console.log('!');
                    soc.send('info');
                });

                function taken(event) {
//                    console.log(event.data)
                    var data = JSON.parse(event.data);
//                    console.log(data)
                    document.getElementById('impprev').src = data.map;
                    document.getElementById('spimpprev').src = data.map;
                    document.getElementById('Map').src = data.map;
                    document.getElementById('online').innerHTML = "Players: "+data.online;
                    document.getElementById('text').innerHTML = data.text;
//                    console.log(data.js)
//                    console.log(document.getElementById('prevmpjs').src)
                    document.getElementById('prevmpjs').src = data.js;
                    // console.log(data.WH)
                    WH = Number(data.WH)
                    // console.log(WH)
                    BGLayers = data.bg;
                    UpdateBG()
                    MainScreen.style.background = data.bg_cl
                    VIEW_X = data.VIEW_X
                    VIEW_Y = data.VIEW_Y
                    RolesList = data.roles;
                    console.log(RolesList)
                    document.getElementById('RoleSelect').innerHTML = "";

                    let justbool = true
                    for (let _ of RolesList) {
                        document.getElementById('RoleSelect').innerHTML+='<option value = "'+_[0]+'" onclick="setItem(\'RoleSelectVal\',this.value)">'+_[1]+'</option>'
                        if (Number(_[0]) == Number(sessionStorage.getItem('RoleSelectVal')) ){
                        justbool = false
                        }
                    }

                    if (justbool || sessionStorage.getItem('RoleSelectVal') =='' ||sessionStorage.getItem('RoleSelectVal') ==null ){
                        document.getElementById('RoleSelect').value = RolesList[0][0]

                    }else{
                        document.getElementById('RoleSelect').value = sessionStorage.getItem('RoleSelectVal')
                    }

                    
                    // ShowPrevVeh();
                    
                }

                soc.addEventListener('message', taken);
			}catch{
                document.getElementById("online").innerHTML = "?/?"
                document.getElementById("text").innerHTML = "No information yet"
                document.getElementById("impprev").src = ""
                document.getElementById("spimpprev").src = ""
			}
}
var MAPstatic = {
'*':[],
'B':[],
'Z':[],
'G':[],
'S':[],
'Q':[],
'_':[],
'CT':{
        weather:"Clear",
		sf: '#000',
		ss: '#000',
		bg:'#000',
		zs:'#000',
		zf:'#000',
		bf:'#000',
		bs:'#000',
		gf:'#000',
		gs:'#000',
		o0:'#000',
		o1:'#000',
		l0:'#000',
		l1:'#000',
		b0:'#000',
		b1:'#000',
		b2:'#000',
		fs:"rgba(0,0,0,0)",
		os:"rgba(0,0,0,0)",

	}
};

let Zoom = 320
let currentZoom = 320
let socket = null
let curView = 0
let Xmod = false
let Cmod = false
let LoadScrHidn = false
let ShakeXbnds = 0
let ShakeYbnds = 0
let SENDB = ''
let SENDS = ''
let X=16
let Y =16
let nX=16
let Z = 0
let speed = 0;
let nY =16
let Deg = 0
let newDeg = 0
let vehicle = 0
let WH =32
let OffsetX = 0
let OffsetY=0
let indicators = document.getElementById('indicators')

document.getElementById('VolumeRange').value = localStorage.getItem('SettingsVolumeRangeVal')
document.getElementById('MusicRange').value = localStorage.getItem('SettingsMusicRangeVal')
UpdtVolumes()
let MSGTKNDT = new Date();
let FPS = 30;
let PING = 0;
let LastPING = Date.now();
let Send = false;
let hp = document.getElementById('HPNum');
// let ZonesNum = document.getElementById('Zones');
let moneyb = document.getElementById('MoneyB');
let gasnum = document.getElementById('GasNum');
let spdnum = document.getElementById('SpdNum');
let dirnum = document.getElementById('DirNum');
let tornum = document.getElementById('TorNum');
let aarnum = document.getElementById('AARocketNum');
let bmbnum = document.getElementById('BombNum');
let carrynum = document.getElementById('CarryNum');
let smknum = document.getElementById('SmkNum');
let tracernum = document.getElementById('TracerNum');
let num120 = document.getElementById('Num120');
let num45 = document.getElementById('Num45');
let num20 = document.getElementById('Num20');
let num8 = document.getElementById('Num8');
let xmodnum = document.getElementById('XmodNum');
let cmodnum = document.getElementById('CmodNum');
let PlayerMark = document.getElementById('PlayerMark');
let xnum = document.getElementById('XNum');
let ynum = document.getElementById('YNum');
let canvas = document.getElementById('MainCanvas');
let playerModulesCanvas = document.getElementById('player-modules-canvas')
let pmcctx = playerModulesCanvas.getContext('2d');
pmcctx.globalCompositeOperation='xor';
playerModulesCanvas.width = 160
playerModulesCanvas.height = 160
let chatview = document.getElementById('ChatView');
let map = document.getElementById('MapForm');
let mapimg = document.getElementById('Map');
let tab = document.getElementById('TabForm');
let moneys = document.getElementById('MoneyB');
let nicknameinput = document.getElementById('NameField');
let messageinput = document.getElementById('MessageFieldTxt');
messageinput.onkeydown = function (event){
    if (event.keyCode == 9 || event.keyCode == 17) {
        if (messagebtn.innerText == "Global"){
            messagebtn.innerText = "Team"
        }else{
            messagebtn.innerText = "Global"
        }
    }
}
let messagefield = document.getElementById('MessageField');
let messagebtn = document.getElementById('MessageFieldBtn');
let mapimgwh = 100
let mapimgrect =null
let ctx = canvas.getContext('2d');
ctx.globalCompositeOperation='xor';
resize();
let BURNING = false;
WtrParticles0 = [];
let RainParticles0 = [];
let RainParticles0max = 500;
let SnowParticles0 = [];
let SnowParticles0max = 100;
let FireParticles0 = [];
let FireParticles1 = [];
let FireParticles2 = [];
let RocketTraceParticles = [];
let CanBangParticles0 = [];
let CanBangParticles1 = [];
let FireParticles0max = 20;
let FireParticles0speed= 0.25;
let FireParticles0size = 3;
let WtrBangParticles0 = [];
let BangParticles0 = [];
let BangParticles1 = [];
let BangParticles2 = [];
let SmokeParticles0 = [];
let SmokeParticles0rate = 60;
let TracerParticles1 = [];

function changeColor(){
sessionStorage.setItem("SelectedCL",document.querySelector('input[name="color"]:checked').value)
}
try{
document.querySelector('input[name="color"][value="'+ sessionStorage.getItem("SelectedCL")+'"]').checked = true
}
catch{}

let MSGs = [];
let Particles = new Map();

let mouse_input = new Map();
let post_mouse_input = new Map();
[0,1,2,3,4].forEach(i => {
    mouse_input.set(i,false);
    post_mouse_input.set(i,false);
});


let mouseX = 0;
let mouseY = 0;
let INFO = '';
let MAP = new Map()
MAP.set('b',new Map())
MAP.set('s',new Map())
MAP.set('z',new Map())
MAP.set('g',new Map())
let lastMSGid = 0
let Entities = new Map()
let Strucures = new Map()

function startgame() {
    document.getElementById('chk-game').checked = true
    GameStatus = "InGame"
    UpdateObjs = true
    PIXI.sound.stop('MainMenuMusic')
	if (true) {
		canvas.addEventListener("mousedown", mclick, false);
		document.addEventListener("mouseup", mrelease, false);
		document.addEventListener('mousemove', mousepos, false);
		document.addEventListener('fullscreenchange', fresize  );
		document.addEventListener('keydown',keydown);
		document.addEventListener('keyup', keyup);
		messagefield.addEventListener("focusout",mifo)
		document.addEventListener("wheel", onWheel);

		try {
			socket = new WebSocket(document.getElementById('ServerAddress').value);
			socket.addEventListener('open', function (event) {

				socket.send('n'+nicknameinput.value+'\n'+document.querySelector('input[name="color"]:checked').value+'\n'+document.querySelector('input[name="SpawnPoints"]:checked').value+'\n'+document.querySelector('input[name="veh'+document.querySelector('input[name="SpawnPoints"]:checked').value+'"]:checked').value+'\n'+document.getElementById('NICK').innerText+'\n'+document.getElementById('PASS').innerText);
				//vehicle = Number(document.getElementById('VehicleSelect').value)
			});
			function taken(event) {
			    lastMSGid = event.data.split(',')[0]
			    let eventdata = event.data.slice(lastMSGid.length+1,event.data.length)
			    // console.log(eventdata)
                document.querySelector('input[name="veh'+document.querySelector('input[name="SpawnPoints"]:checked').value+'"]:checked').value
                
			    lastMSGid = Number(lastMSGid)
				if (eventdata[0] == 'E'){
				    GameStatus= "Error"
					document.getElementById('TitleScreen').classList = ['titlescrh']
					document.getElementById("chkInterfaceHide").checked = false
					alert( eventdata.split(',')[1])
				}else if(eventdata[0] == 'M'){

                    document.getElementById('TitleScreen').classList = ['titlescrh']
                    var xmlHttp = new XMLHttpRequest();
                    xmlHttp.open( "GET", eventdata.substring(1), false ); // false for synchronous request
                    xmlHttp.send( null );
                    MAPstatic = JSON.parse(xmlHttp.responseText);
                    // console.log(MAPstatic)
                    for (let struct_char in StructuresTable) {
                        if (MAPstatic.hasOwnProperty(struct_char)){
                            
                            MAPstatic[struct_char].forEach(element => {
                                new StructuresTable[struct_char](element)
                                
                            });

                        }
                    }
                    // console.log(MAPstatic)
                    
                    
                    for (let _ in MAPstatic['#']){
                        for(let t in MAPstatic['#'][_]){
                            MAPstatic['#'][_][t].push(0)
                        }
                    }
                    WH = MAPstatic['WH']
                    // ZonesNum.innerHTML = ''
                    // for(let _ = 0; _ < MAPstatic['*'].length; _++){
                    //     ZonesNum.innerHTML += '<div class="Zone" style="background-color: red" id="zone'+_ +'"><b>'+MAPstatic['*'][_][0]+'</b></div>'
                    // }

                    setTimeout(function(){UpdateObjs = true}, 300);
                    socket.send('OK');
				}
				else if (eventdata[0] == 'D'){
						// GameStatus = "MainMenu"
						// PlayersData = new Map()
						// PIXI.sound.play('MainMenuMusic');
                        // let children = document.getElementById('Inventory').children;
                        // for (let i = 0; i < children.length; i++) {
                        //   children[i].style.display = "none"
                        // }
                        // document.getElementById("chk-game").checked = false
                        // document.getElementById("chkInterfaceHide").checked = false
                        // chatview.innerHTML = ""
                        // StartMainMusicPlay = Date.now()
                        // Players = []
                        // socket.close();
                        ExitGame()
				}else if (eventdata[0] == 'R'){
						socket.close();
						SaveMusicPos()
						location.replace(event.data.slice(1));
				}else {
 					MSGTKNDT = new Date();
					INFO = eventdata;
					PING = Date.now() - LastPING;
					LastPING = Date.now();
					let infarr = INFO.split('\n');
					let grad = null;
					Players = []
					splstr = infarr[0].split(',')
					PlayerTags = new Map()
					PlayerName = splstr[4]
					CurVehicleID = Number(splstr[2])
					CurVehicleType = Number(splstr[3])
                    // console.log(INFO)
					Z = Number(splstr[1])
					Money = splstr[0]
//					Zones = splstr[splstr.length -1].toString()
//					for(let _ = 0; _ < Zones.length; _++){
//                        let tmp = document.getElementById("zone"+_.toString());
//                        if (Zones[_] == '1'){
//                            tmp.style.background = '#44f'
//                        }else{
//                            tmp.style.background = '#f00'
//                        }
//					}
					// argarr = []
					// for (let _ = 4; _ < splstr.length; _++){
                    //             argarr.push(splstr[_])
					// }
                    if (!(PlayerName=="" || PlayerName == undefined)){
//                        console.log(PlayerName)
                        // PlayerName = NoTeamTag(PlayerName,true)
//                        console.log(PlayerName)
                        // Players.push([PlayerName,CurVehicleType]);
                        // console.log(VehiclesTable.)
                        if (!(TVehicles.has(CurVehicleID))){
                            TVehicles.set(CurVehicleID,new VehiclesTable[CurVehicleType](CurVehicleID,PlayerName))
                        }
                        let pad = splstr[0].length + 1 + splstr[1].length + 1 + splstr[2].length + 1 + splstr[3].length + 1
//                        console.log(infarr[0],pad)
                         
                        let str = infarr[0].slice(pad)
//                        console.log(str)
                        TVehicles.get(CurVehicleID).updatep(str)
                    }else{
                    UpdateObjs= true
                    }
					if(!(moneyb == null)) {
						moneyb.innerText = Money
					}
					PlayerMark.style.left = (X/WH*100).toString()+'%'
					PlayerMark.style.top = (Y/WH*100).toString()+'%'
					if (infarr[0].split(',')[6]==0 && false){
						BURNING = true
					}
					let ceilswas = false;
					for (let h = 1; h < infarr.length; h++) {
						let larr =infarr[h].split(',');
						// console.log(larr[0])
						if (larr[0] == '#'){
                            switch (larr[1]) {
                                case 'c':
                                    Entities.set(larr[3],new EntitiesTable[larr[2]](larr))
                                    break;
                                case 'u':
                                    if (Entities.has(larr[3])){
                                        Entities.get(larr[3]).update(larr)
                                    }
                                case 'd':
                                    if (Entities.has(larr[3])){
                                        Entities.get(larr[3]).delete(larr)
                                    }
                                    break;
                            }
                            

						}else 	if (larr[0] == '+' ){
//						    console.log(larr)
                            is_deleting = false
                            CVID = larr[1]
                            veh = null
                            if (larr[2] == '!'){
                                if (TVehicles.has(CVID)){
                                    veh = TVehicles.get(CVID)
                                    TVehicles.delete(CVID)
                                }
                                is_deleting = true
                                larr.shift()
                            }
                            
                            PN = larr[3]
                            CVT = larr[2]
                            if (!(TVehicles.has(CVID)) && (!(is_deleting))){
                                TVehicles.set(CVID,new VehiclesTable[CVT](CVID,PN))
                            }
                            let pad = larr[0].length + 1 + larr[1].length + 1 + larr[2].length + 1 //+ larr[3].length + 1


                            let str = infarr[h].slice(pad)
//                            console.log(str)
                            if (is_deleting){
                                try{
                                    veh.updatee(str)
                                }catch{

                                }
                            }else{
                                TVehicles.get(CVID).updatee(str)

                            }
                            
                            
						}
					}
					dellarr = []
                    
                    while (dellarr.length > 0){
                        PlayersData.delete(dellarr[0])
                        dellarr.shift()
                    }
                    let substr = ""
                    new Array(0,1,2,3,4).forEach(i => {
                        substr += (mouse_input.get(i) || post_mouse_input.get(i)   ? 1 : 0).toString()
                    });
                    // console.log(substr)

                    TVehicles.get(CurVehicleID).input_keys.forEach(ik => {
                        substr += (ik.is_pressed || ik.was_pressed ? 1 : 0).toString()
                    });
                    // console.log(substr)
                    TVehicles.get(CurVehicleID).input_keys.forEach(ik => {
                        
                            ik.was_pressed = false
                        
                    });
                    new Array(0,1,2,3,4).forEach(i => {
                        post_mouse_input.set(i,false)
                    });
					socket.send(lastMSGid.toString()+','+((mouseX-GameW/2/window.devicePixelRatio)/Zoom*window.devicePixelRatio).toString()+','+((mouseY-GameH/2/window.devicePixelRatio)/Zoom*window.devicePixelRatio).toString()+','+substr);


			}}
			socket.addEventListener('message', taken);
			socket.onerror =  function (e) {
				document.getElementById('TitleScreen').classList = ['titlescrh']
				document.getElementById("chkInterfaceHide").checked = false
//				console.log('ERROR')
			}

		} catch (err){
//		    console.log(err,err.stack)
		}
	}
}


function resize(){
    GameW = window.innerWidth*window.devicePixelRatio;
    GameH = window.innerHeight*window.devicePixelRatio;
	canvas.width  = window.innerWidth*window.devicePixelRatio;
	canvas.height = window.innerHeight*window.devicePixelRatio;
	canvas.style.width = window.innerWidth + "px";
	canvas.style.height = window.innerHeight + "px";
    ZoomCorrection()
}
function fresize(){
    GameW = window.innerWidth*window.devicePixelRatio;
    GameH = window.innerHeight*window.devicePixelRatio;
	canvas.width  = window.innerWidth*window.devicePixelRatio;
	canvas.height = window.innerHeight*window.devicePixelRatio;
	canvas.style.width = window.innerWidth + "px";
	canvas.style.height = window.innerHeight + "px";
	ZoomCorrection()
}
function mclick(event) {
    mouse_input.set(event.button,true)
	post_mouse_input.set(event.button,true)
}
function mrelease(event){
	mouse_input.set(event.button,false)
}
function mifo() {
	messagefield.style.display = 'none'
}
function keydown(event) {
    // console.log(TVehicles)
    // console.log(CurVehicleID)
    // console.log(TVehicles.get(CurVehicleID))
    TVehicles.get(CurVehicleID).input_keys.forEach(ik => {
        // console.log(ik.cur_char, keyboardMap[ik.cur_char])
        if (event.keyCode==ik.cur_char){
            ik.is_pressed = true
            ik.was_pressed = true
        }
    });
	// if (messagefield.style.display == 'none' && (event.keyCode == 87 || event.keyCode == 65 || event.keyCode == 83 || event.keyCode == 68 || event.keyCode == 32|| event.keyCode == 71 || event.keyCode == 79|| event.keyCode == 70)){
	// 	input.set(event.keyCode,true);
	// 	dobleinput.set(event.keyCode,true)
	// }
	//  else if (event.key == 'Enter' && GameStatus == "InGame") {
	// 	if (messagefield.style.display == 'none'){
	// 		messagefield.style.display = 'block';
	// 		messageinput.focus();
	// 	}else {
	// 		messagefield.style.display = 'none'
	// 		Send = true;
	// 	}
	// }
    if ( (event.keyCode == 113 )) {
        document.getElementById("chkInterfaceHide").checked = (!(document.getElementById("chkInterfaceHide").checked))
        cameraMode = document.getElementById("chkInterfaceHide").checked
	}else if ( (event.keyCode == 114 )) {
	    if(document.getElementById("MainCanvas").style.cursor == 'crosshair'){
	        document.getElementById("MainCanvas").style.cursor = 'none'
	    }else{
	        document.getElementById("MainCanvas").style.cursor = 'crosshair'
	    }
	}else if(event.keyCode == 115){
        module_view_mode=(!module_view_mode)
    }
    
    //else if ( (event.keyCode == 86 )) {
	// 	curView = (curView+1)%Vehicles[CurVehicle].views
	// 	document.getElementById('ViewImg').src = Vehicles[CurVehicle].viewsIcons[curView]
	// }else if (messagefield.style.display == 'none' && (event.keyCode == 77 )) {
	// 	map.style.display = 'block';
	// }else if (messagefield.style.display == 'none' && (event.keyCode == 9) ) {
	// 	input.set('Tab',true);
	// 	tab.style.display = 'block';
	// }
}
function keyup(event) {
    TVehicles.get(CurVehicleID).input_keys.forEach(ik => {
        if (event.keyCode==ik.cur_char){
            ik.is_pressed = false
        }
    });
	// if (event.keyCode == 87 || event.keyCode == 65 || event.keyCode == 83 || event.keyCode == 68 || event.keyCode == 32 || event.keyCode == 71|| event.keyCode == 79|| event.keyCode == 70){
	// 	input.set(event.keyCode,false);
	// } else if (event.keyCode == 77 ) {
	// 	map.style.display = 'none';
	// }else if (event.keyCode == 9 ) {
	// 	tab.style.display = 'none';
	// }
}
let start = null;
let timenow = Date.now()
let VisibleObjs = new Object()
let UpdateObjs = true
let QupdtSequence = 0
function DRAW(timestamp)  {

try{
    if (GameStatus == "InGame"){
    if(MAPstatic.CT.weather == 'Snow' ){
    if (SnowParticles0.length == 0){
        for(var i = 0; i < SnowParticles0max; i++)
        {
            SnowParticles0.push(new Particle2(canvas.width,canvas.height))
        }
    }
    }else{
        if (SnowParticles0.length > 0){
        SnowParticles0 = []
        }
    }
    }else{
        if (RainParticles0.length > 0){
        RainParticles0 = []
        }
    }
    timenow = Date.now()
	if(BURNING){
		ShakeXbnds += 0.25
		ShakeYbnds += 0.25
	}
	ShakeXbnds = ShakeXbnds*0.9
	ShakeYbnds = ShakeYbnds*0.9
	OffsetX = Math.random()*ShakeXbnds-ShakeXbnds/2
	OffsetY = Math.random()*ShakeYbnds-ShakeYbnds/2
	LastFPS = Date.now()
	FPS = 1000/(Date.now()-LastAnime)
	LastAnime = Date.now()
    if (!start) start = timestamp;
    let progress = timestamp - start; //'#2879ADFF'
	ctx.clearRect(0, 0, canvas.width, canvas.height)
	pmcctx.clearRect(0, 0, canvas.width, canvas.height)
	ctx.fillStyle = MAPstatic.CT.bg;
	ctx.fillRect(0,0,canvas.width,canvas.height);
	ctx.fill()
    if (GameStatus == "InGame" || true){

    LayerList.forEach(drawLayer);


    TVehicles.forEach(vehicle => {
        vehicle.first_appearance = false
        //TODO
        if ( module_view_mode){

            vehicle.draw_indicators("BOTTOM")
            vehicle.draw_indicators("DEFAULT")
        }
        if (vehicle.id == CurVehicleID) {
            vehicle.draw_player_indicators("BOTTOM")
            vehicle.draw_player_indicators("DEFAULT")
        }
    });


    for (let _ of Entities.keys()) {
        if (!(Entities.get(_).is_active)){
            Entities.delete(_)    
        }

    }
    for (let _ of Particles.keys()) {
        let i = 0;
        while (i < Particles.get(_).length){
            if (Particles.get(_)[i].is_active==false){
                Particles.get(_).splice(i, 1)
                i--
            }
            i++
        }

    }
        }

        window.requestAnimationFrame(DRAW);
       }catch(e)
       {
      console.log(e,e.stack)
       window.requestAnimationFrame(DRAW);
       }
}
LastAnime = Date.now()
window.requestAnimationFrame(DRAW);
function mousepos(e){
	mouseX = e.pageX;
	mouseY = e.pageY;
}
window.onload=function () {
document.getElementById('TitleScreen').classList = ['titlescrh']
GetServerInfo()
UpdtKeybinds()
if(navigator.userAgent.match(/iPhone/i)){
document.documentElement.requestFullscreen()
}
}
function startgamebtn() {
PIXI.sound.stop('MainMenuMusic');
document.getElementById('TitleScreen').classList = ['titlescrs']
setTimeout(startgame,1500)
}
